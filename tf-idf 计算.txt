简单来说，这段代码的计算流程可以分为以下几个主要步骤：

预处理阶段：更新词条文档数

统计文档数： 先从所有文档中统计出总的文档数量。

更新词条统计： 对于每个词条，查询它在多少个文档中出现（document_count），然后批量更新到词条记录中。

并行计算 TF-IDF 权重（分批处理）：

批量拆分： 将所有词条分成多个小批次，每个批次包含若干个词条。

多线程计算： 对于每个批次，启动一个线程执行下面的计算：

获取索引数据： 对每个词条，从索引表中取出该词条在各个文档中的记录（包含词频 TF 和对应的文档 ID）。

计算基础 TF-IDF： 对每个记录，利用公式 tfidf = tf * log(total_docs / document_count) 计算基本的 TF-IDF 值。

附加加权： 如果该词条出现在文档的标题中，则额外加上一个固定分值（例如 1.5）；如果出现在作者中，则加上另外一个固定分值（例如 0.8）。

结果收集： 将计算后的记录（包含记录的 ID 和新的 TF-IDF 值）放到一个共享的队列中。

汇总与数据库更新：

收集结果： 等所有线程计算完成后，从共享队列中收集所有批次的更新项。

重置旧值： 在更新之前，先把所有索引表中的 TF-IDF 值重置为 0。

批量更新： 将所有新计算的 TF-IDF 值分批更新到数据库中，确保每次更新都是在一个事务中完成的，以保证数据一致性。